apiVersion: serving.knative.dev/v1
kind: Service
metadata:
  name: openclawbot-svc-plus
  labels:
    cloud.googleapis.com/location: asia-northeast1
  annotations:
    run.googleapis.com/ingress: all
    run.googleapis.com/ingress-status: all
spec:
  template:
    metadata:
      annotations:
        # Enable GCS volume mounting
        run.googleapis.com/execution-environment: gen2
        # Auto-scaling configuration
        autoscaling.knative.dev/minScale: '1'
        autoscaling.knative.dev/maxScale: '10'
        # CPU allocation (always allocated for WebSocket connections)
        run.googleapis.com/cpu-throttling: 'false'
    spec:
      # Service account for GCS access and Secret Manager
      serviceAccountName: openclawbot-sa@xzerolab-480008.iam.gserviceaccount.com
      
      containers:
      - name: openclawbot
        # Image will be set by Cloud Build
        image: asia-northeast1-docker.pkg.dev/xzerolab-480008/cloud-run-source-deploy/openclawbot.svc.plus/openclawbot-svc-plus:latest
        
        ports:
        - name: http1
          containerPort: 8080
        
        
        env:
        # Cloud Run will set PORT automatically
        - name: NODE_ENV
          value: production
        - name: OPENCLAW_STATE_DIR
          value: /data
        - name: OPENCLAW_GATEWAY_MODE
          value: local
        - name: OPENCLAW_CONFIG_PATH
          value: /data/openclaw.json
        # Gateway authentication token from Secret Manager
        # Shared with console.svc.plus and accounts.svc.plus
        - name: OPENCLAW_GATEWAY_TOKEN
          valueFrom:
            secretKeyRef:
              name: internal-service-token
              key: latest
        - name: INTERNAL_SERVICE_TOKEN
          valueFrom:
            secretKeyRef:
              name: internal-service-token
              key: latest
        
        resources:
          limits:
            cpu: '2'
            memory: 4Gi
        
        # Mount GCS bucket for persistent storage
        volumeMounts:
        - name: gcs-data
          mountPath: /data
        
        
        # Startup probe - TCP check for WebSocket service
        startupProbe:
          tcpSocket:
            port: 8080
          initialDelaySeconds: 10
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 24
        
        # Liveness probe - TCP check to verify container is alive
        livenessProbe:
          tcpSocket:
            port: 8080
          initialDelaySeconds: 60
          periodSeconds: 30
          timeoutSeconds: 5
          failureThreshold: 3
      
      # GCS volume configuration
      volumes:
      - name: gcs-data
        csi:
          driver: gcsfuse.run.googleapis.com
          # Replace with your GCS bucket name
          volumeAttributes:
            bucketName: openclawbot-data
            mountOptions: "implicit-dirs,uid=1000,gid=1000"
